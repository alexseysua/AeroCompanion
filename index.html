<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Controller Interface</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background: #333;
            display: flex;
            flex-direction: column;
        }

        #video-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
            height: 100%;
        }

        #drone-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            margin-bottom: 20px;
        }

        .gimbal {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin: 0;
        }

        #left-gimbal {
            margin-left: 40px; 
        }

        #right-gimbal {
            margin-right: 40px; 
        }

        #command-input {
            flex-grow: 1;
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            margin: 0 10px;
        }

        #record-button {
            width: 50px;
            height: 50px;
            margin-left: 70px;
            background: grey;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #stream-toggle {
            width: 50px;
            height: 50px;
            margin-right: 70px;
            background: grey;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .record-on {
            background-color: red;
        }

        .record-off {
            background-color: grey;
        }

        .stream-on {
            background-color: rgb(0, 0, 255);
        }

        .stream-off {
            background-color: grey;
        }

        #no-signal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.75); 
            padding: 10px 20px;
            font-size: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2; 
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #333;
        }

        .joystick {
            width: 100px;
            height: 100px;
            background-color: gray;
            border-radius: 50%;
            position: relative;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="drone-video" width="100%" height="100%" autoplay></video>
        <div id="no-signal" style="display: flex;">No Signal</div>
    </div>
    <div id="controls">
        <div id="left-joystick" class="joystick"></div>
        <button id="record-button" class="record-off"></button>
        <input type="text" id="command-input" placeholder="Command output" readonly>
        <button id="stream-toggle" class="stream-off"></button>
        <div id="right-joystick" class="joystick"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.8.0/nipplejs.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const recordButton = document.getElementById('record-button');
            const videoButton = document.getElementById('stream-toggle');
            const commandInput = document.getElementById('command-input');

            let recognition;
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
                    const commands = ['move forward', 'move backward', 'pan left', 'pan right', 'move up', 'move down', 'roll left', 'roll right'];
                    if (commands.includes(transcript)) {
                        appendCommand(transcript.charAt(0).toUpperCase() + transcript.slice(1));
                        sendUdpCommand(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    console.log('Speech recognition error: ' + event.error);
                    if (event.error === 'no-speech') {
                        recognition.stop();
                        recognition.start();
                    }
                };
            } else {
                console.log('Speech recognition not supported in this browser.');
            }

            recordButton.addEventListener('click', function() {
                this.classList.toggle('record-on');
                if (this.classList.contains('record-on')) {
                    this.style.backgroundColor = 'red';
                    appendCommand('Record On');
                    if (recognition) recognition.start();
                } else {
                    this.style.backgroundColor = 'grey';
                    appendCommand('Record Off');
                    if (recognition) recognition.stop();
                }
            });

            videoButton.addEventListener('click', function() {
                this.classList.toggle('stream-on');
                if (this.classList.contains('stream-on')) {
                    this.style.backgroundColor = 'blue';
                    appendCommand('Video On');
                } else {
                    this.style.backgroundColor = 'grey';
                    appendCommand('Video Off');
                }
            });

            // Add long press and double click to clear text input
            let inputPressTimer;
            commandInput.addEventListener('mousedown', function() {
                inputPressTimer = setTimeout(function() {
                    commandInput.value = '';
                }, 1000); // Adjust the duration as needed
            });

            commandInput.addEventListener('mouseup', function() {
                clearTimeout(inputPressTimer);
            });

            commandInput.addEventListener('dblclick', function() {
                commandInput.value = '';
            });
        });

        const video = document.getElementById('drone-video');
        const noSignal = document.getElementById('no-signal');
        const recordButton = document.getElementById('record-button');
        const streamToggle = document.getElementById('stream-toggle');
        const commandInput = document.getElementById('command-input');

        let lastCommand = '';
        let commandTimeout;
        let peerConnection;
        let dataChannel;

        // Initialize WebRTC connection
        async function initializeWebRTC() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            peerConnection = new RTCPeerConnection(configuration);

            dataChannel = peerConnection.createDataChannel("commandChannel");
            dataChannel.onopen = () => {
                console.log("Data channel is open");
            };
            dataChannel.onclose = () => {
                console.log("Data channel is closed");
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // Send the ICE candidate to the other peer (not implemented in this example)
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocal
