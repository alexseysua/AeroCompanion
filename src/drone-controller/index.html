<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Controller Interface</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background: #333;
            display: flex;
            flex-direction: column;
        }

        #video-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
            height: 100%;
        }

        #drone-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            margin-bottom: 20px;
        }

        .gimbal {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin: 0; /* Ensure no additional margin is affecting the position */
        }

        #left-gimbal {
            margin-left: 40px; 
        }

        #right-gimbal {
            margin-right: 40px; 
        }

        #command-input {
            flex-grow: 1; /* This will allow the input box to expand to fill available space */
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            margin: 0 10px; /* Ensures some spacing between elements */
        }

        #record-button {
            width: 50px;
            height: 50px;
            margin-left: 70px;
            background: grey;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #stream-toggle {
            width: 50px;
            height: 50px;
            margin-right: 70px;
            background: grey;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .record-on {
            background-color: red;
        }

        .record-off {
            background-color: grey;
        }

        .stream-on {
            background-color: rgb(0, 0, 255);
        }

        .stream-off {
            background-color: grey;
        }

        #no-signal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.75); 
            padding: 10px 20px;
            font-size: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2; 
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #333;
        }

        .joystick {
            width: 100px;
            height: 100px;
            background-color: gray;
            border-radius: 50%;
            position: relative;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="drone-video" width="100%" height="100%" autoplay></video>
        <div id="no-signal" style="display: flex;">No Signal</div>
    </div>
    <div id="controls">
        <div id="left-joystick" class="joystick"></div>
        <button id="record-button" class="record-off"></button>
        <input type="text" id="command-input" placeholder="Command output" readonly>
        <button id="stream-toggle" class="stream-off"></button>
        <div id="right-joystick" class="joystick"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.8.0/nipplejs.min.js" integrity="sha384-JYVTOoL0fyJejEpfYNzZTPoGzzhfUbIGR1YWNcgVh8kPsuSG4tQ2XtDaJI5RJBdE" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha384-S3wQ/l0OsbJoFeJC81UIr3JOlx/OzNJpRt1bV+yhpWQxPAahfpQtpxBSfn+Isslc" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const recordButton = document.getElementById('record-button');
            const videoButton = document.getElementById('stream-toggle');
            const commandInput = document.getElementById('command-input');

            let recognition;
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
                    const commands = ['move forward', 'move backward', 'pan left', 'pan right', 'move up', 'move down', 'roll left', 'roll right', 'video on', 'video off', 'record on', 'record off'];
                    if (commands.includes(transcript)) {
                        appendCommand(transcript.charAt(0).toUpperCase() + transcript.slice(1));
                        sendUdpCommand(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    console.log('Speech recognition error: ' + event.error);
                    if (event.error === 'no-speech') {
                        recognition.stop();
                        recognition.start();
                    }
                };
            } else {
                console.log('Speech recognition not supported in this browser.');
            }

            recordButton.addEventListener('click', function() {
                this.classList.toggle('record-on');
                if (this.classList.contains('record-on')) {
                    this.style.backgroundColor = 'red';
                    appendCommand('Record On');
                    sendUdpCommand('Record On');
                    if (recognition) recognition.start();
                } else {
                    this.style.backgroundColor = 'grey';
                    appendCommand('Record Off');
                    sendUdpCommand('Record Off');
                    if (recognition) recognition.stop();
                }
            });

            videoButton.addEventListener('click', function() {
                this.classList.toggle('stream-on');
                if (this.classList.contains('stream-on')) {
                    this.style.backgroundColor = 'blue';
                    appendCommand('Video On');
                    sendUdpCommand('Video On');
                } else {
                    this.style.backgroundColor = 'grey';
                    appendCommand('Video Off');
                    sendUdpCommand('Video Off');
                }
            });

            // Add long press and double click to clear text input
            let inputPressTimer;
            commandInput.addEventListener('mousedown', function() {
                inputPressTimer = setTimeout(function() {
                    commandInput.value = '';
                }, 1000); // Adjust the duration as needed
            });

            commandInput.addEventListener('mouseup', function() {
                clearTimeout(inputPressTimer);
            });

            commandInput.addEventListener('dblclick', function() {
                commandInput.value = '';
            });
        });

        const video = document.getElementById('drone-video');
        const noSignal = document.getElementById('no-signal');
        const recordButton = document.getElementById('record-button');
        const streamToggle = document.getElementById('stream-toggle');
        const commandInput = document.getElementById('command-input');
        let lastCommand = '';
        let commandTimeout;
        const udpPort = 41234;

        function encryptMessage(message, key) {
            const iv = CryptoJS.lib.WordArray.random(16);
            const encrypted = CryptoJS.AES.encrypt(message, key, { iv: iv });
            return iv.concat(encrypted.ciphertext).toString(CryptoJS.enc.Base64);
        }

        function hmacHash(message, key) {
            return CryptoJS.HmacSHA256(message, key).toString();
        }

        function sendUdpCommand(command) {
            const key = CryptoJS.enc.Hex.parse('your-secure-key-here');
            const timestamp = Date.now().toString();
            const nonce = CryptoJS.lib.WordArray.random(16).toString();
            const message = `${command}|${timestamp}|${nonce}`;
            const encryptedMessage = encryptMessage(message, key);
            const hash = hmacHash(encryptedMessage, key);
            const udpMessage = `${encryptedMessage}|${hash}`;

            const socket = new WebSocket(`ws://localhost:${udpPort}`);
            socket.onopen = () => {
                socket.send(udpMessage);
                socket.close();
            };
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Initialize the joysticks using nipplejs
        const leftJoystick = nipplejs.create({
            zone: document.getElementById('left-joystick'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'red'
        });

        const rightJoystick = nipplejs.create({
            zone: document.getElementById('right-joystick'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'blue'
        });

        leftJoystick.on('move', (evt, data) => {
            processJoystickCommand('left', data);
        });

        rightJoystick.on('move', (evt, data) => {
            processJoystickCommand('right', data);
        });

        function startVideoStream() {
            const streamUrl = 'http://drone-video-stream-url';
            video.src = streamUrl;

            video.onerror = () => {
                noSignal.style.display = 'block';
            };

            video.onplay = () => {
                noSignal.style.display = 'none';
            };
        }

        function processJoystickCommand(joystick, data) {
            let commandString = '';

            if (joystick === 'left') {
                if (data.angle.degree > 45 && data.angle.degree <= 135) {
                    commandString = 'Move Up';
                } else if (data.angle.degree > 135 && data.angle.degree <= 225) {
                    commandString = 'Pan Left';
                } else if (data.angle.degree > 225 && data.angle.degree <= 315) {
                    commandString = 'Move Down';
                } else {
                    commandString = 'Pan Right';
                }
            } else if (joystick === 'right') {
                if (data.angle.degree > 45 && data.angle.degree <= 135) {
                    commandString = 'Move Forward';
                } else if (data.angle.degree > 135 && data.angle.degree <= 225) {
                    commandString = 'Roll Left';
                } else if (data.angle.degree > 225 && data.angle.degree <= 315) {
                    commandString = 'Move Backward';
                } else {
                    commandString = 'Roll Right';
                }
            }

            if (commandString !== lastCommand) {
                lastCommand = commandString;
                appendCommand(commandString);
                sendUdpCommand(commandString);
            }

            // Clear previous timeout and set a new one to reset the lastCommand after a delay
            clearTimeout(commandTimeout);
            commandTimeout = setTimeout(() => {
                lastCommand = '';
            }, 500); // Adjust the delay as needed
        }

        function appendCommand(command) {
            commandInput.value += command + '     \n'; // Add 5 spaces between each command
            commandInput.scrollTop = commandInput.scrollHeight; // Scroll to the bottom
        }
        
        recordButton.addEventListener('click', () => {
            const command = 'TOGGLE_RECORD';
            sendUdpCommand(command);
        });

        streamToggle.addEventListener('click', () => {
            const command = 'TOGGLE_STREAM';
            sendUdpCommand(command);
        });

        const crypto = require('crypto');

        const algorithm = 'aes-256-cbc';
        const secretKey = crypto.randomBytes(32); // Store this securely
        const iv = crypto.randomBytes(16); // Initialization vector

        function encrypt(text) {
            const cipher = crypto.createCipheriv(algorithm, secretKey, iv);
            let encrypted = cipher.update(text, 'utf8', 'hex');
            encrypted += cipher.final('hex');
            return encrypted;
        }

        function hmacHash(encryptedMessage) {
            const hmac = crypto.createHmac('sha256', secretKey);
            hmac.update(encryptedMessage);
            return hmac.digest('hex');
        }

        function getNonce() {
            return crypto.randomBytes(16).toString('hex');
        }

        // Start the video stream on page load
        startVideoStream();
    </script>   
</body>
</html>
